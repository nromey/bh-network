{%- comment -%}
NCO schedule table include

PARAMS (common):
  title:         string heading (default: "NCO Schedule")
  caption:       optional table caption (screen-reader visible; defaults to a helpful message)
  desc:          optional longer screen-reader-only description linked via aria-describedby
  schedule:      a data object that contains items (preferred path)
  items_key:     key inside schedule that contains the list (default: "items")
  show_location: true/false (default: false)
  location_md:   markdown for location label/link (optional)
  time_local:    "HH:MM" 24h start time (default: "10:00")
  tz_full:       "Eastern", etc. (default: "Eastern")

ROW SHAPE (data-driven preferred):
  items:
    - date: "YYYY-MM-DD"
      nco: "CALLSIGN" | "TBD"
      notes: "optional"
      unassigned: true|false

FALLBACK (generator mode if items missing):
  weeks: number (default 12)
  dow:   "SU|MO|TU|WE|TH|FR|SA" (default "SA")
  roster: ["N2DYI", "K5NER", ...]  (strings)
{%- endcomment -%}

{%- assign _title        = include.title | default: "NCO Schedule" -%}
{%- assign _sched        = include.schedule -%}
{%- assign _items_key    = include.items_key | default: "items" -%}
{%- assign _items        = nil -%}
{%- if _sched -%}{%- assign _items = _sched[_items_key] -%}{%- endif -%}

{%- assign _weeks       = include.weeks | default: (_sched.weeks | default: 12) -%}
{%- assign _dow         = include.dow | default: (_sched.dow | default: "SA") -%}
{%- assign _time_local  = include.time_local | default: (_sched.time_local | default: "10:00") -%}
{%- assign _tz_full     = include.tz_full | default: (_sched.tz_full | default: "Eastern") -%}
{%- assign _roster      = include.roster | default: _sched.roster -%}
{%- assign _show_loc    = include.show_location | default: false -%}
{%- assign _location_md = include.location_md | default: (_sched.location_md | default: "") -%}

{%- comment -%} Helper: caption + optional long description for SRs {%- endcomment -%}
{%- assign _caption_default = _title | append: ". Rows marked “Unassigned” indicate no operator has been assigned yet." -%}
{%- assign _caption = include.caption | default: _caption_default -%}
{%- assign _desc     = include.desc | default: "" -%}
{%- assign _desc_id  = "nco-desc-" | append: _title | slugify -%}

{%- comment -%} Helper: convert "HH:MM" -> "h:mm AM/PM" {%- endcomment -%}
{%- assign _time_disp = "" -%}
{%- if _time_local and _time_local != "" -%}
  {%- assign _tp = "2000-01-01 " | append: _time_local -%}
  {%- assign _time_disp = _tp | date: "%-I:%M %p" -%}
{%- endif -%}

{%- comment -%} Helper: map DOW code -> number (0=Sun..6=Sat) {%- endcomment -%}
{%- assign _dow_code = _dow | upcase | strip -%}
{%- assign _downum = -1 -%}
{%- assign _map = "SU:0|MO:1|TU:2|WE:3|TH:4|FR:5|SA:6" | split:"|" -%}
{%- for pair in _map -%}
  {%- assign kv = pair | split: ":" -%}
  {%- if kv[0] == _dow_code -%}{%- assign _downum = kv[1] | plus: 0 -%}{%- endif -%}
{%- endfor -%}
{%- if _downum < 0 -%}{%- assign _downum = 6 -%}{%- endif -%}

{%- assign _rows = _items -%}

{%- if _rows and _rows.size > 0 -%}
  {%- comment -%} Data-driven mode {%- endcomment -%}
{%- else -%}
  {%- comment -%} Generator mode: build rows for next N weeks rotating roster {%- endcomment -%}
  {%- assign _rows = "" | split: "" -%}
  {%- assign now_epoch = site.time | date: "%s" | plus: 0 -%}
  {%- assign wday_now  = site.time | date: "%w" | plus: 0 -%}
  {%- assign delta     = _downum | minus: wday_now -%}
  {%- if delta < 0 -%}{%- assign delta = delta | plus: 7 -%}{%- endif -%}
  {%- assign first_epoch = now_epoch | plus: (delta | times: 86400) -%}

  {%- assign roster_size = 0 -%}
  {%- if _roster and _roster.size -%}{%- assign roster_size = _roster.size -%}{%- endif -%}

  {%- for i in (0.._weeks-1) -%}
    {%- assign off = i | times: 604800 -%}
    {%- assign d_epoch = first_epoch | plus: off -%}
    {%- assign d_iso   = d_epoch | date: "%Y-%m-%d" -%}
    {%- assign d_disp  = d_epoch | date: "%A, %B %-d, %Y" -%}

    {%- assign nco = "" -%}
    {%- if roster_size > 0 -%}
      {%- assign idx = i | modulo: roster_size -%}
      {%- assign nco = _roster[idx] -%}
    {%- endif -%}

    {%- assign row = "" | split: "" -%}
    {%- assign row = row | push: d_iso -%}   {%- comment -%} 0: ISO date {%- endcomment -%}
    {%- assign row = row | push: d_disp -%}  {%- comment -%} 1: display date {%- endcomment -%}
    {%- assign row = row | push: nco -%}     {%- comment -%} 2: NCO {%- endcomment -%}
    {%- assign row = row | push: "" -%}      {%- comment -%} 3: notes {%- endcomment -%}
    {%- assign _rows = _rows | push: row -%}
  {%- endfor -%}
{%- endif -%}

<h2>{{ _title }}</h2>

{%- if _rows and _rows.size > 0 -%}
  {%- if _desc != "" -%}
    <p id="{{ _desc_id }}" class="sr-only">{{ _desc }}</p>
  {%- endif -%}

  <table class="nco-table" {% if _desc != "" %}aria-describedby="{{ _desc_id }}"{% endif %}>
    <caption class="sr-only">{{ _caption }}</caption>
    <thead>
      <tr>
        <th scope="col">Date</th>
        <th scope="col">NCO</th>
        {%- if _show_loc -%}<th scope="col">Location</th>{%- endif -%}
        <th scope="col">Time ({{ _tz_full }})</th>
        <th scope="col">Notes</th>
      </tr>
    </thead>
    <tbody>
      {%- for r in _rows -%}
        {%- assign date_iso   = "" -%}
        {%- assign date_disp  = "" -%}
        {%- assign nco_name   = "" -%}
        {%- assign notes_text = "" -%}

        {%- comment -%} Normalize row shape (hash vs array) {%- endcomment -%}
        {%- if r.date -%}
          {%- assign date_iso   = r.date -%}
          {%- assign date_disp  = r.date | date: "%A, %B %-d, %Y" -%}
          {%- assign nco_name   = r.nco | default: r.operator | default: "" -%}
          {%- assign notes_text = r.notes | default: "" -%}
          {%- assign row_un     = r.unassigned -%}
        {%- else -%}
          {%- assign date_iso   = r[0] -%}
          {%- assign date_disp  = r[1] -%}
          {%- assign nco_name   = r[2] -%}
          {%- assign notes_text = r[3] -%}
          {%- assign row_un     = r[4] -%}  {%- comment -%} optional array slot for unassigned {%- endcomment -%}
        {%- endif -%}

        {%- assign is_unassigned = false -%}
        {%- if row_un -%}{%- assign is_unassigned = true -%}{%- endif -%}
        {%- if is_unassigned == false and nco_name == "TBD" -%}{%- assign is_unassigned = true -%}{%- endif -%}
        {%- if is_unassigned == false and (nco_name == nil or nco_name == "") -%}{%- assign is_unassigned = true -%}{%- endif -%}
        {%- assign un_id = "unassigned-" | append: forloop.index0 -%}

        <tr class="{% if is_unassigned %}nco-unassigned{% endif %}">
          <th scope="row" data-title="Date">
            <time datetime="{{ date_iso }}">{{ date_disp }}</time>
          </th>

          <td data-title="NCO" {% if is_unassigned %}aria-describedby="{{ un_id }}"{% endif %}>
            {{ nco_name | default: "TBD" }}
            {%- if is_unassigned -%}
              <span id="{{ un_id }}" class="sr-only"> — Unassigned</span>
            {%- endif -%}
          </td>

          {%- if _show_loc -%}
            <td data-title="Location">
              {%- if _location_md and _location_md != "" -%}
                {{ _location_md | markdownify | replace: "<p>", "" | replace: "</p>", "" }}
              {%- else -%}
                Blind Hams Bridge
              {%- endif -%}
            </td>
          {%- endif -%}

          <td data-title="Time">
            {%- if _time_disp != "" -%}{{ _time_disp }} {{ _tz_full }}{%- else -%}—{%- endif -%}
          </td>

          <td data-title="Notes">{{ notes_text }}</td>
        </tr>
      {%- endfor -%}
    </tbody>
  </table>
{%- else -%}
  <p><em>No NCOs scheduled yet.</em></p>
{%- endif -%}
