{%- assign _title        = include.title | default: "NCO Schedule" -%}
{%- assign _sched        = include.schedule -%}
{%- assign _items_key    = include.items_key | default: "items" -%}
{%- assign _items        = nil -%}
{%- if _sched -%}{%- assign _items = _sched[_items_key] -%}{%- endif -%}

{%- comment -%} Config / defaults for generator mode {%- endcomment -%}
{%- assign _weeks       = include.weeks | default: (_sched.weeks | default: 12) -%}
{%- assign _dow         = include.dow | default: (_sched.dow | default: "SA") -%}
{%- assign _time_local  = include.time_local | default: (_sched.time_local | default: "10:00") -%}
{%- assign _tz_full     = include.tz_full | default: (_sched.tz_full | default: "Eastern") -%}
{%- assign _roster      = include.roster | default: _sched.roster -%}
{%- assign _show_loc    = include.show_location | default: false -%}
{%- assign _location_md = include.location_md | default: (_sched.location_md | default: "") -%}

{%- comment -%} Helper: convert "HH:MM" -> "h:mm AM/PM" {%- endcomment -%}
{%- assign _time_disp = "" -%}
{%- if _time_local and _time_local != "" -%}
  {%- assign _tp = "2000-01-01 " | append: _time_local -%}
  {%- assign _time_disp = _tp | date: "%-I:%M %p" -%}
{%- endif -%}

{%- comment -%} Helper: map DOW code -> number (0=Sun..6=Sat) {%- endcomment -%}
{%- assign _dow_code = _dow | upcase | strip -%}
{%- assign _downum = -1 -%}
{%- assign _map = "SU:0|MO:1|TU:2|WE:3|TH:4|FR:5|SA:6" | split:"|" -%}
{%- for pair in _map -%}
  {%- assign kv = pair | split: ":" -%}
  {%- if kv[0] == _dow_code -%}{%- assign _downum = kv[1] | plus: 0 -%}{%- endif -%}
{%- endfor -%}
{%- if _downum < 0 -%}{%- assign _downum = 6 -%}{%- endif -%}

{%- assign _rows = _items -%}

{%- if _rows and _rows.size > 0 -%}
  {# data-driven mode; rows already set #}
{%- else -%}
  {%- assign _rows = "" | split: "" -%}
  {%- assign now_epoch = site.time | date: "%s" | plus: 0 -%}
  {%- assign wday_now  = site.time | date: "%w" | plus: 0 -%}
  {%- assign delta     = _downum | minus: wday_now -%}
  {%- if delta < 0 -%}{%- assign delta = delta | plus: 7 -%}{%- endif -%}
  {%- assign first_epoch = now_epoch | plus: (delta | times: 86400) -%}

  {%- assign roster_size = 0 -%}
  {%- if _roster and _roster.size -%}{%- assign roster_size = _roster.size -%}{%- endif -%}

  {%- for i in (0.._weeks-1)_
