{%- comment -%}
Usage examples:

{% include nets_page.html
   nets=site.data.nets.nets
   title="Blind Hams Nets"
   category="bhn"
   section_id="nets-bhn"
   nco_anchor="nco-schedule" %}

Notes:
- Expects /assets/js/net-view.js to handle the radio toggle.
  Tip: in your JS, consider KEY = "netView:" + (location.pathname || "/") for per-page preferences.
- Data expectations per net:
  id, name, description, rrule (optional legacy), start_local ("HH:MM"),
  duration_min, freq (DAILY|WEEKLY|MONTHLY...), byday ("MO,WE,FR"...),
  tz (short; optional), tz_full (optional; e.g., "Eastern"), schedule_text (optional override)
{%- endcomment -%}

{%- assign title = include.title | default: "Nets" -%}
{%- assign cat = include.category | default: "bhn" -%}
{%- assign section_id = include.section_id | default: "nets-section" -%}
{%- assign nco_anchor = include.nco_anchor | default: "nco-schedule" -%}
{%- assign filtered = include.nets | where: "category", cat -%}

<section class="nets-section" data-view="table" id="{{ section_id }}">
  <header class="nets-header">
    <h2>{{ title }}</h2>

    <!-- Display toggle -->
    <fieldset class="view-toggle" aria-label="Display format">
      <legend class="sr-only">Display format</legend>
      <label>
        <input type="radio" name="net-view-{{ section_id }}" value="table" checked>
        Table
      </label>
      <label>
        <input type="radio" name="net-view-{{ section_id }}" value="headings">
        Headings
      </label>
    </fieldset>
  </header>

  {%- comment -%}
    Helper notes:
    - We compute a displayable 12-hour time from either n.start_local or from a legacy " at " in n.rrule.
    - We humanize BYDAY codes (MO,TU,WE...) and build a phrase like:
        "Daily", "Saturdays", or "Mon, Wed & Fri"
    - Then we append "at <time> <tz_full>" => "Saturdays at 10:00 AM Eastern"
    - If schedule_text is provided in data, we use it as-is and append nothing else.
  {%- endcomment -%}

  <!-- TABLE VIEW (default; no-JS friendly) -->
  <div class="view view-table" aria-live="polite">
    <table>
      <thead>
        <tr>
          <th scope="col">Net</th>
          <th scope="col">When</th>
          <th scope="col">Duration</th>
          <th scope="col">Location</th>
        </tr>
      </thead>
      <tbody>
      {% for n in filtered %}
        {%- assign _tz_full = n.tz_full | default: "Eastern" -%}
        {%- comment -%} Compute time (12-hour) {%- endcomment -%}
        {%- assign _display_time = "" -%}
        {%- if n.start_local and n.start_local != "" -%}
          {%- assign _tparse = '2000-01-01 ' | append: n.start_local -%}
          {%- assign _display_time = _tparse | date: "%-I:%M %p" -%}
        {%- elsif n.rrule and n.rrule contains " at " -%}
          {%- assign _at_bits = n.rrule | split: " at " -%}
          {%- assign _legacy = '2000-01-01 ' | append: _at_bits.last -%}
          {%- assign _display_time = _legacy | date: "%-I:%M %p" -%}
        {%- endif -%}

        {%- comment -%} Build humanized day/frequency phrase {%- endcomment -%}
        {%- assign _schedule_phrase = "" -%}
        {%- if n.schedule_text and n.schedule_text != "" -%}
          {%- assign _schedule_phrase = n.schedule_text -%}
        {%- else -%}
          {%- assign _freq = n.freq | default: "" | upcase -%}
          {%- assign _byday = n.byday | default: "" -%}
          {%- assign _byday_pretty = "" -%}
          {%- if _byday != "" -%}
            {%- assign _days = _byday | split: "," -%}
            {%- assign _pretty_days = "" -%}
            {%- for d in _days -%}
              {%- assign d2 = d | strip -%}
              {%- assign name = d2
                | replace: "MO","Mon"
                | replace: "TU","Tue"
                | replace: "WE","Wed"
                | replace: "TH","Thu"
                | replace: "FR","Fri"
                | replace: "SA","Sat"
                | replace: "SU","Sun" -%}
              {%- if forloop.first -%}
                {%- assign _pretty_days = name -%}
              {%- elsif forloop.last -%}
                {%- assign _pretty_days = _pretty_days | append: " & " | append: name -%}
              {%- else -%}
                {%- assign _pretty_days = _pretty_days | append: ", " | append: name -%}
              {%- endif -%}
            {%- endfor -%}
            {%- comment -%} If only one day, pluralize (e.g., "Saturday" -> "Saturdays") {%- endcomment -%}
            {%- if _days.size == 1 -%}
              {%- assign _byday_pretty = _pretty_days | append: "s" -%}
            {%- else -%}
              {%- assign _byday_pretty = _pretty_days -%}
            {%- endif -%}
          {%- endif -%}

          {%- if _freq == "DAILY" -%}
            {%- assign _schedule_phrase = "Daily" -%}
          {%- elsif _byday_pretty != "" -%}
            {%- assign _schedule_phrase = _byday_pretty -%}
          {%- endif -%}

          {%- if _schedule_phrase == "" and _display_time != "" -%}
            {%- assign _schedule_phrase = _display_time | append: " " | append: _tz_full -%}
          {%- elsif _schedule_phrase != "" and _display_time != "" -%}
            {%- assign _schedule_phrase = _schedule_phrase | append: " at " | append: _display_time | append: " " | append: _tz_full -%}
          {%- endif -%}
        {%- endif -%}

        <tr>
          <td>
            <strong>{{ n.name }}</strong><br>
            <small>{{ n.description }}</small>
            {%- if n.id == "bh-digital" -%}
              <br><a href="#{{ nco_anchor }}">See NCO schedule ↓</a>
            {%- endif -%}
          </td>
          <td>
            {%- if _schedule_phrase != "" -%}
              {{ _schedule_phrase }}
            {%- else -%}
              —
            {%- endif -%}
          </td>
          <td>
            {%- if n.duration_min -%}{{ n.duration_min }} min{%- else -%}—{%- endif -%}
          </td>
          <td>{% include net_location.html net=n %}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- HEADINGS VIEW (hidden until chosen) -->
  <div class="view view-headings" hidden aria-live="polite">
    {% for n in filtered %}
      {%- assign _tz_full = n.tz_full | default: "Eastern" -%}
      {%- assign _display_time = "" -%}
      {%- if n.start_local and n.start_local != "" -%}
        {%- assign _tparse = '2000-01-01 ' | append: n.start_local -%}
        {%- assign _display_time = _tparse | date: "%-I:%M %p" -%}
      {%- elsif n.rrule and n.rrule contains " at " -%}
        {%- assign _at_bits = n.rrule | split: " at " -%}
        {%- assign _legacy = '2000-01-01 ' | append: _at_bits.last -%}
        {%- assign _display_time = _legacy | date: "%-I:%M %p" -%}
      {%- endif -%}

      {%- assign _schedule_phrase = "" -%}
      {%- if n.schedule_text and n.schedule_text != "" -%}
        {%- assign _schedule_phrase = n.schedule_text -%}
      {%- else -%}
        {%- assign _freq = n.freq | default: "" | upcase -%}
        {%- assign _byday = n.byday | default: "" -%}
        {%- assign _byday_pretty = "" -%}
        {%- if _byday != "" -%}
          {%- assign _days = _byday | split: "," -%}
          {%- assign _pretty_days = "" -%}
          {%- for d in _days -%}
            {%- assign d2 = d | strip -%}
            {%- assign name = d2
              | replace: "MO","Mon"
              | replace: "TU","Tue"
              | replace: "WE","Wed"
              | replace: "TH","Thu"
              | replace: "FR","Fri"
              | replace: "SA","Sat"
              | replace: "SU","Sun" -%}
            {%- if forloop.first -%}
              {%- assign _pretty_days = name -%}
            {%- elsif forloop.last -%}
              {%- assign _pretty_days = _pretty_days | append: " & " | append: name -%}
            {%- else -%}
              {%- assign _pretty_days = _pretty_days | append: ", " | append: name -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if _days.size == 1 -%}
            {%- assign _byday_pretty = _pretty_days | append: "s" -%}
          {%- else -%}
            {%- assign _byday_pretty = _pretty_days -%}
          {%- endif -%}
        {%- endif -%}

        {%- if _freq == "DAILY" -%}
          {%- assign _schedule_phrase = "Daily" -%}
        {%- elsif _byday_pretty != "" -%}
          {%- assign _schedule_phrase = _byday_pretty -%}
        {%- endif -%}

        {%- if _schedule_phrase == "" and _display_time != "" -%}
          {%- assign _schedule_phrase = _display_time | append: " " | append: _tz_full -%}
        {%- elsif _schedule_phrase != "" and _display_time != "" -%}
          {%- assign _schedule_phrase = _schedule_phrase | append: " at " | append: _display_time | append: " " | append: _tz_full -%}
        {%- endif -%}
      {%- endif -%}

      <article class="net-block">
        <h3>{{ n.name }}</h3>

        <p class="net-when">
          <strong>When:</strong>
          {%- if _schedule_phrase != "" -%}
            {{ _schedule_phrase }}
          {%- else -%}
            —
          {%- endif -%}
          {%- if n.duration_min %} ({{ n.duration_min }} min){% endif -%}
        </p>

        {%- if n.id == "bh-digital" -%}
          <p><a href="#{{ nco_anchor }}">See NCO schedule ↓</a></p>
        {%- endif -%}

        <p class="net-where"><strong>Where:</strong> {% include net_location.html net=n %}</p>
        <p class="net-desc">{{ n.description }}</p>
      </article>
      {% unless forloop.last %}<hr>{% endunless %}
    {% endfor %}
  </div>
</section>

<!-- Tiny script (loaded once per page) -->
<script defer src="/assets/js/net-view.js"></script>
