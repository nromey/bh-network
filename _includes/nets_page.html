{%- comment -%}
Renders a list of nets (table + headings views) with humanized schedule text.

Expected fields per net (you can provide only rrule + start_local):
  id, name, description,
  start_local ("HH:MM" 24h),
  duration_min,
  rrule (e.g., "FREQ=WEEKLY;BYDAY=SA" or "FREQ=MONTHLY;BYDAY=TH;BYSETPOS=1"),
  tz_full (optional, e.g., "Eastern"),
  schedule_text (optional override string shown verbatim),
  location fields used by net_location.html

We parse RRULE into FREQ/BYDAY/BYSETPOS when present.
{%- endcomment -%}

{%- assign title = include.title | default: "Nets" -%}
{%- assign cat = include.category | default: "bhn" -%}
{%- assign section_id = include.section_id | default: "nets-section" -%}
{%- assign nco_anchor = include.nco_anchor | default: "nco-schedule" -%}
{%- assign filtered = include.nets | where: "category", cat -%}

{%- comment -%}
Helper snippet: given n, compute:
  _tz_full, _display_time, _rfreq, _byday_codes, _bysetpos, _byday_names_singular, _byday_names_plural, _ord_word, _schedule_phrase
This block is duplicated in both views (scoped to each n).
{%- endcomment -%}

<section class="nets-section" data-view="table" id="{{ section_id }}">
  <header class="nets-header">
    <h2>{{ title }}</h2>

    <fieldset class="view-toggle" aria-label="Display format">
      <legend class="sr-only">Display format</legend>
      <label>
        <input type="radio" name="net-view-{{ section_id }}" value="table" checked>
        Table
      </label>
      <label>
        <input type="radio" name="net-view-{{ section_id }}" value="headings">
        Headings
      </label>
    </fieldset>
  </header>

  <!-- TABLE VIEW -->
  <div class="view view-table" aria-live="polite">
    <table>
      <thead>
        <tr>
          <th scope="col">Net</th>
          <th scope="col">When</th>
          <th scope="col">Duration</th>
          <th scope="col">Location</th>
        </tr>
      </thead>
      <tbody>
      {% for n in filtered %}
        {%- assign _tz_full = n.tz_full | default: "Eastern" -%}

        {%- comment -%} Time display from start_local or legacy " at " in rrule {%- endcomment -%}
        {%- assign _display_time = "" -%}
        {%- if n.start_local and n.start_local != "" -%}
          {%- assign _tparse = '2000-01-01 ' | append: n.start_local -%}
          {%- assign _display_time = _tparse | date: "%-I:%M %p" -%}
        {%- elsif n.rrule and n.rrule contains " at " -%}
          {%- assign _at_bits = n.rrule | split: " at " -%}
          {%- assign _legacy = '2000-01-01 ' | append: _at_bits.last -%}
          {%- assign _display_time = _legacy | date: "%-I:%M %p" -%}
        {%- endif -%}

        {%- comment -%} Parse RRULE into freq/day/setpos {%- endcomment -%}
        {%- assign _rfreq = "" -%}
        {%- assign _rbyday = "" -%}
        {%- assign _rbysetpos = "" -%}
        {%- if n.rrule and n.rrule != "" -%}
          {%- assign _parts = n.rrule | split: ";" -%}
          {%- for p in _parts -%}
            {%- assign kv = p | split: "=" -%}
            {%- assign k = kv[0] | upcase -%}
            {%- assign v = kv[1] -%}
            {%- if k == "FREQ" -%}{%- assign _rfreq = v | upcase -%}{%- endif -%}
            {%- if k == "BYDAY" -%}{%- assign _rbyday = v -%}{%- endif -%}
            {%- if k == "BYSETPOS" -%}{%- assign _rbysetpos = v -%}{%- endif -%}
          {%- endfor -%}
        {%- endif -%}

        {%- comment -%} Derive BYDAY codes (prefer explicit fields if provided) {%- endcomment -%}
        {%- assign _byday_codes = n.byday | default: _rbyday | default: "" -%}

        {%- comment -%} Humanize day names (full names) {%- endcomment -%}
        {%- assign _names = "" -%}
        {%- assign _day_list = "" | split: "" -%}
        {%- if _byday_codes != "" -%}
          {%- assign _days = _byday_codes | split: "," -%}
          {%- for d in _days -%}
            {%- assign d2 = d | strip | upcase -%}
            {%- assign day_full = d2
              | replace: "MO","Monday"
              | replace: "TU","Tuesday"
              | replace: "WE","Wednesday"
              | replace: "TH","Thursday"
              | replace: "FR","Friday"
              | replace: "SA","Saturday"
              | replace: "SU","Sunday" -%}
            {%- assign _day_list = _day_list | push: day_full -%}
          {%- endfor -%}
          {%- assign _names = "" -%}
          {%- for dn in _day_list -%}
            {%- if forloop.first -%}
              {%- assign _names = dn -%}
            {%- elsif forloop.last -%}
              {%- assign _names = _names | append: " & " | append: dn -%}
            {%- else -%}
              {%- assign _names = _names | append: ", " | append: dn -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}

        {%- comment -%} Build pluralized version for weekly phrasing (e.g., "Saturdays") {%- endcomment -%}
        {%- assign _names_plural = _names -%}
        {%- if _day_list and _day_list.size == 1 -%}
          {%- assign _names_plural = _day_list[0] | append: "s" -%}
        {%- endif -%}

        {%- comment -%} Ordinal word for BYSETPOS (MONTHLY) {%- endcomment -%}
        {%- assign _ord_word = "" -%}
        {%- if _rbysetpos and _rbysetpos != "" -%}
          {%- assign _ord_map = "1:First|2:Second|3:Third|4:Fourth|5:Fifth|-1:Last" | split: "|" -%}
          {%- for pair in _ord_map -%}
            {%- assign kv = pair | split: ":" -%}
            {%- if kv[0] == _rbysetpos -%}{%- assign _ord_word = kv[1] -%}{%- endif -%}
          {%- endfor -%}
        {%- endif -%}

        {%- comment -%} Compose the schedule phrase {%- endcomment -%}
        {%- assign _schedule_phrase = "" -%}
        {%- if n.schedule_text and n.schedule_text != "" -%}
          {%- assign _schedule_phrase = n.schedule_text -%}
        {%- else -%}
          {%- case _rfreq -%}
            {%- when "DAILY" -%}
              {%- assign _schedule_phrase = "Daily" -%}
            {%- when "WEEKLY" -%}
              {%- if _names_plural != "" -%}
                {%- assign _schedule_phrase = _names_plural -%}
              {%- else -%}
                {%- assign _schedule_phrase = "Weekly" -%}
              {%- endif -%}
            {%- when "MONTHLY" -%}
              {%- if _ord_word != "" and _names != "" -%}
                {%- assign _schedule_phrase = _ord_word | append: " " | append: _names | append: " of the month" -%}
              {%- else -%}
                {%- assign _schedule_phrase = "Monthly" -%}
              {%- endif -%}
            {%- else -%}
              {%- if _names_plural != "" -%}
                {%- assign _schedule_phrase = _names_plural -%}
              {%- endif -%}
          {%- endcase -%}

          {%- if _display_time != "" -%}
            {%- if _schedule_phrase == "" -%}
              {%- assign _schedule_phrase = _display_time | append: " " | append: _tz_full -%}
            {%- else -%}
              {%- assign _schedule_phrase = _schedule_phrase | append: " at " | append: _display_time | append: " " | append: _tz_full -%}
            {%- endif -%}
          {%- endif -%}
        {%- endif -%}

        <tr>
          <td>
            <strong>{{ n.name }}</strong><br>
            <small>{{ n.description }}</small>
            {%- if n.id == "bh-digital" -%}
              <br><a href="#{{ nco_anchor }}">See NCO schedule ↓</a>
            {%- endif -%}
          </td>
          <td>
            {%- if _schedule_phrase != "" -%}{{ _schedule_phrase }}{%- else -%}—{%- endif -%}
          </td>
          <td>{%- if n.duration_min -%}{{ n.duration_min }} min{%- else -%}—{%- endif -%}</td>
          <td>{% include net_location.html net=n %}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- HEADINGS VIEW -->
  <div class="view view-headings" hidden aria-live="polite">
    {% for n in filtered %}
      {%- assign _tz_full = n.tz_full | default: "Eastern" -%}

      {%- assign _display_time = "" -%}
      {%- if n.start_local and n.start_local != "" -%}
        {%- assign _tparse = '2000-01-01 ' | append: n.start_local -%}
        {%- assign _display_time = _tparse | date: "%-I:%M %p" -%}
      {%- elsif n.rrule and n.rrule contains " at " -%}
        {%- assign _at_bits = n.rrule | split: " at " -%}
        {%- assign _legacy = '2000-01-01 ' | append: _at_bits.last -%}
        {%- assign _display_time = _legacy | date: "%-I:%M %p" -%}
      {%- endif -%}

      {%- assign _rfreq = "" -%}
      {%- assign _rbyday = "" -%}
      {%- assign _rbysetpos = "" -%}
      {%- if n.rrule and n.rrule != "" -%}
        {%- assign _parts = n.rrule | split: ";" -%}
        {%- for p in _parts -%}
          {%- assign kv = p | split: "=" -%}
          {%- assign k = kv[0] | upcase -%}
          {%- assign v = kv[1] -%}
          {%- if k == "FREQ" -%}{%- assign _rfreq = v | upcase -%}{%- endif -%}
          {%- if k == "BYDAY" -%}{%- assign _rbyday = v -%}{%- endif -%}
          {%- if k == "BYSETPOS" -%}{%- assign _rbysetpos = v -%}{%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- assign _byday_codes = n.byday | default: _rbyday | default: "" -%}
      {%- assign _names = "" -%}
      {%- assign _day_list = "" | split: "" -%}
      {%- if _byday_codes != "" -%}
        {%- assign _days = _byday_codes | split: "," -%}
        {%- for d in _days -%}
          {%- assign d2 = d | strip | upcase -%}
          {%- assign day_full = d2
            | replace: "MO","Monday"
            | replace: "TU","Tuesday"
            | replace: "WE","Wednesday"
            | replace: "TH","Thursday"
            | replace: "FR","Friday"
            | replace: "SA","Saturday"
            | replace: "SU","Sunday" -%}
          {%- assign _day_list = _day_list | push: day_full -%}
        {%- endfor -%}
        {%- for dn in _day_list -%}
          {%- if forloop.first -%}
            {%- assign _names = dn -%}
          {%- elsif forloop.last -%}
            {%- assign _names = _names | append: " & " | append: dn -%}
          {%- else -%}
            {%- assign _names = _names | append: ", " | append: dn -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
      {%- assign _names_plural = _names -%}
      {%- if _day_list and _day_list.size == 1 -%}
        {%- assign _names_plural = _day_list[0] | append: "s" -%}
      {%- endif -%}

      {%- assign _ord_word = "" -%}
      {%- if _rbysetpos and _rbysetpos != "" -%}
        {%- assign _ord_map = "1:First|2:Second|3:Third|4:Fourth|5:Fifth|-1:Last" | split: "|" -%}
        {%- for pair in _ord_map -%}
          {%- assign kv = pair | split: ":" -%}
          {%- if kv[0] == _rbysetpos -%}{%- assign _ord_word = kv[1] -%}{%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- assign _schedule_phrase = "" -%}
      {%- if n.schedule_text and n.schedule_text != "" -%}
        {%- assign _schedule_phrase = n.schedule_text -%}
      {%- else -%}
        {%- case _rfreq -%}
          {%- when "DAILY" -%}
            {%- assign _schedule_phrase = "Daily" -%}
          {%- when "WEEKLY" -%}
            {%- if _names_plural != "" -%}
              {%- assign _schedule_phrase = _names_plural -%}
            {%- else -%}
              {%- assign _schedule_phrase = "Weekly" -%}
            {%- endif -%}
          {%- when "MONTHLY" -%}
            {%- if _ord_word != "" and _names != "" -%}
              {%- assign _schedule_phrase = _ord_word | append: " " | append: _names | append: " of the month" -%}
            {%- else -%}
              {%- assign _schedule_phrase = "Monthly" -%}
            {%- endif -%}
          {%- else -%}
            {%- if _names_plural != "" -%}
              {%- assign _schedule_phrase = _names_plural -%}
            {%- endif -%}
        {%- endcase -%}

        {%- if _display_time != "" -%}
          {%- if _schedule_phrase == "" -%}
            {%- assign _schedule_phrase = _display_time | append: " " | append: _tz_full -%}
          {%- else -%}
            {%- assign _schedule_phrase = _schedule_phrase | append: " at " | append: _display_time | append: " " | append: _tz_full -%}
          {%- endif -%}
        {%- endif -%}
      {%- endif -%}

      <article class="net-block">
        <h3>{{ n.name }}</h3>
        <p class="net-when">
          <strong>When:</strong>
          {%- if _schedule_phrase != "" -%}{{ _schedule_phrase }}{%- else -%}—{%- endif -%}
          {%- if n.duration_min %} ({{ n.duration_min }} min){% endif -%}
        </p>
        {%- if n.id == "bh-digital" -%}
          <p><a href="#{{ nco_anchor }}">See NCO schedule ↓</a></p>
        {%- endif -%}
        <p class="net-where"><strong>Where:</strong> {% include net_location.html net=n %}</p>
        <p class="net-desc">{{ n.description }}</p>
      </article>
      {% unless forloop.last %}<hr>{% endunless %}
    {% endfor %}
  </div>
</section>

<script defer src="/assets/js/net-view.js"></script>
