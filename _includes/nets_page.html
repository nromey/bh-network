{%- comment -%}
Usage:

{% include nets_page.html
   nets=site.data.nets.nets
   title="Blind Hams Nets"
   category="bhn"
   section_id="nets-bhn"
   nco_anchor="nco-schedule" %}

Notes:
- JS toggle is in /assets/js/net-view.js (global preference recommended).
- Data per net:
  id, name, description, start_local ("HH:MM"), duration_min,
  rrule (e.g., "FREQ=WEEKLY;BYDAY=SA" or "FREQ=MONTHLY;BYDAY=TH;BYSETPOS=1"),
  tz_full (optional, e.g., "Eastern"), schedule_text (optional override)
{%- endcomment -%}

{%- assign title = include.title | default: "Nets" -%}
{%- assign cat = include.category | default: "bhn" -%}
{%- assign section_id = include.section_id | default: "nets-section" -%}
{%- assign nco_anchor = include.nco_anchor | default: "nco-schedule" -%}
{%- assign filtered = include.nets | where: "category", cat -%}

<section class="nets-section" data-view="table" id="{{ section_id }}">
  <header class="nets-header">
    <h2>{{ title }}</h2>

    <fieldset class="view-toggle" aria-label="Display format">
      <legend class="sr-only">Display format</legend>
      <label>
        <input type="radio" name="net-view-{{ section_id }}" value="table" checked>
        Table
      </label>
      <label>
        <input type="radio" name="net-view-{{ section_id }}" value="headings">
        Headings
      </label>
    </fieldset>
  </header>

  <!-- TABLE VIEW -->
  <div class="view view-table" aria-live="polite">
    <table>
      <thead>
        <tr>
          <th scope="col">Net</th>
          <th scope="col">When</th>
          <th scope="col">Duration</th>
          <th scope="col">Location</th>
        </tr>
      </thead>
      <tbody>
      {% for n in filtered %}
        {%- assign _tz_full = n.tz_full | default: "Eastern" -%}

        {%- comment -%} Compute time in 12-hour {%- endcomment -%}
        {%- assign _display_time = "" -%}
        {%- if n.start_local and n.start_local != "" -%}
          {%- assign _tparse = '2000-01-01 ' | append: n.start_local -%}
          {%- assign _display_time = _tparse | date: "%-I:%M %p" -%}
        {%- elsif n.rrule and n.rrule contains " at " -%}
          {%- assign _at_bits = n.rrule | split: " at " -%}
          {%- assign _legacy = '2000-01-01 ' | append: _at_bits.last -%}
          {%- assign _display_time = _legacy | date: "%-I:%M %p" -%}
        {%- endif -%}

        {%- comment -%} Extract FREQ, BYDAY, BYSETPOS from RRULE if needed {%- endcomment -%}
        {%- assign _freq = "" -%}
        {%- assign _byday = "" -%}
        {%- assign _bysetpos = "" -%}
        {%- if n.rrule and n.rrule contains "=" -%}
          {%- assign _parts = n.rrule | split: ";" -%}
          {%- for p in _parts -%}
            {%- if p contains "=" -%}
              {%- assign kv = p | split: "=" -%}
              {%- assign k = kv[0] | upcase | strip -%}
              {%- assign v = kv[1] | strip -%}
              {%- if k == "FREQ" and _freq == "" -%}{%- assign _freq = v | upcase -%}{%- endif -%}
              {%- if k == "BYDAY" and _byday == "" -%}{%- assign _byday = v -%}{%- endif -%}
              {%- if k == "BYSETPOS" and _bysetpos == "" -%}{%- assign _bysetpos = v -%}{%- endif -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}

        {%- comment -%} Humanize BYDAY to names {%- endcomment -%}
        {%- assign _byday_pretty = "" -%}
        {%- if _byday != "" -%}
          {%- assign _days = _byday | split: "," -%}
          {%- assign _pretty_days = "" -%}
          {%- for d in _days -%}
            {%- assign d2 = d | strip -%}
            {%- assign name = d2
              | replace: "MO","Mon"
              | replace: "TU","Tue"
              | replace: "WE","Wed"
              | replace: "TH","Thu"
              | replace: "FR","Fri"
              | replace: "SA","Sat"
              | replace: "SU","Sun" -%}
            {%- if forloop.first -%}
              {%- assign _pretty_days = name -%}
            {%- elsif forloop.last -%}
              {%- assign _pretty_days = _pretty_days | append: " & " | append: name -%}
            {%- else -%}
              {%- assign _pretty_days = _pretty_days | append: ", " | append: name -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if _days.size == 1 -%}
            {%- assign _byday_pretty = _pretty_days | append: "s" -%}
          {%- else -%}
            {%- assign _byday_pretty = _pretty_days -%}
          {%- endif -%}
        {%- endif -%}

        {%- comment -%} Special shorthands for common sets {%- endcomment -%}
        {%- assign _byday_upper = _byday | upcase -%}
        {%- if _byday_upper == "MO,TU,WE,TH,FR" -%}{%- assign _byday_pretty = "Weekdays" -%}{%- endif -%}
        {%- if _byday_upper == "SA,SU" -%}{%- assign _byday_pretty = "Weekends" -%}{%- endif -%}

        {%- comment -%} Humanize BYSETPOS for monthly patterns {%- endcomment -%}
        {%- assign _pos_pretty = "" -%}
        {%- if _bysetpos != "" -%}
          {%- assign _pos_map = "1:First|2:Second|3:Third|4:Fourth|-1:Last" -%}
          {%- assign _pairs = _pos_map | split: "|" -%}
          {%- for pair in _pairs -%}
            {%- assign kv = pair | split: ":" -%}
            {%- if kv[0] == _bysetpos -%}
              {%- assign _pos_pretty = kv[1] -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}

        {%- comment -%} Compose schedule phrase {%- endcomment -%}
        {%- assign _schedule_phrase = "" -%}
        {%- if n.schedule_text and n.schedule_text != "" -%}
          {%- assign _schedule_phrase = n.schedule_text -%}
        {%- else -%}
          {%- if _freq == "DAILY" -%}
            {%- assign _schedule_phrase = "Daily" -%}
          {%- elsif _freq == "MONTHLY" and _pos_pretty != "" and _byday_pretty != "" -%}
            {%- assign _schedule_phrase = _pos_pretty | append: " " | append: _byday_pretty | replace: "s", "" -%}
          {%- elsif _byday_pretty != "" -%}
            {%- assign _schedule_phrase = _byday_pretty -%}
          {%- endif -%}

          {%- if _schedule_phrase == "" and _display_time != "" -%}
            {%- assign _schedule_phrase = _display_time | append: " " | append: _tz_full -%}
          {%- elsif _schedule_phrase != "" and _display_time != "" -%}
            {%- assign _schedule_phrase = _schedule_phrase | append: " at " | append: _display_time | append: " " | append: _tz_full -%}
          {%- endif -%}
        {%- endif -%}

        <tr>
          <td>
            <strong>{{ n.name }}</strong><br>
            <small>{{ n.description }}</small>
            {%- if n.id == "bh-digital" -%}
              <br><a href="#{{ nco_anchor }}">See NCO schedule ↓</a>
            {%- endif -%}
          </td>
          <td>{% if _schedule_phrase != "" %}{{ _schedule_phrase }}{% else %}—{% endif %}</td>
          <td>{% if n.duration_min %}{{ n.duration_min }} min{% else %}—{% endif %}</td>
          <td>{% include net_location.html net=n %}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- HEADINGS VIEW -->
  <div class="view view-headings" hidden aria-live="polite">
    {% for n in filtered %}
      {%- assign _tz_full = n.tz_full | default: "Eastern" -%}

      {%- assign _display_time = "" -%}
      {%- if n.start_local and n.start_local != "" -%}
        {%- assign _tparse = '2000-01-01 ' | append: n.start_local -%}
        {%- assign _display_time = _tparse | date: "%-I:%M %p" -%}
      {%- elsif n.rrule and n.rrule contains " at " -%}
        {%- assign _at_bits = n.rrule | split: " at " -%}
        {%- assign _legacy = '2000-01-01 ' | append: _at_bits.last -%}
        {%- assign _display_time = _legacy | date: "%-I:%M %p" -%}
      {%- endif -%}

      {%- assign _freq = "" -%}
      {%- assign _byday = "" -%}
      {%- assign _bysetpos = "" -%}
      {%- if n.rrule and n.rrule contains "=" -%}
        {%- assign _parts = n.rrule | split: ";" -%}
        {%- for p in _parts -%}
          {%- if p contains "=" -%}
            {%- assign kv = p | split: "=" -%}
            {%- assign k = kv[0] | upcase | strip -%}
            {%- assign v = kv[1] | strip -%}
            {%- if k == "FREQ" and _freq == "" -%}{%- assign _freq = v | upcase -%}{%- endif -%}
            {%- if k == "BYDAY" and _byday == "" -%}{%- assign _byday = v -%}{%- endif -%}
            {%- if k == "BYSETPOS" and _bysetpos == "" -%}{%- assign _bysetpos = v -%}{%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- assign _byday_pretty = "" -%}
      {%- if _byday != "" -%}
        {%- assign _days = _byday | split: "," -%}
        {%- assign _pretty_days = "" -%}
        {%- for d in _days -%}
          {%- assign d2 = d | strip -%}
          {%- assign name = d2
            | replace: "MO","Mon"
            | replace: "TU","Tue"
            | replace: "WE","Wed"
            | replace: "TH","Thu"
            | replace: "FR","Fri"
            | replace: "SA","Sat"
            | replace: "SU","Sun" -%}
          {%- if forloop.first -%}
            {%- assign _pretty_days = name -%}
          {%- elsif forloop.last -%}
            {%- assign _pretty_days = _pretty_days | append: " & " | append: name -%}
          {%- else -%}
            {%- assign _pretty_days = _pretty_days | append: ", " | append: name -%}
          {%- endif -%}
        {%- endfor -%}
        {%- if _days.size == 1 -%}
          {%- assign _byday_pretty = _pretty_days | append: "s" -%}
        {%- else -%}
          {%- assign _byday_pretty = _pretty_days -%}
        {%- endif -%}
      {%- endif -%}

      {%- assign _byday_upper = _byday | upcase -%}
      {%- if _byday_upper == "MO,TU,WE,TH,FR" -%}{%- assign _byday_pretty = "Weekdays" -%}{%- endif -%}
      {%- if _byday_upper == "SA,SU" -%}{%- assign _byday_pretty = "Weekends" -%}{%- endif -%}

      {%- assign _pos_pretty = "" -%}
      {%- if _bysetpos != "" -%}
        {%- assign _pos_map = "1:First|2:Second|3:Third|4:Fourth|-1:Last" -%}
        {%- assign _pairs = _pos_map | split: "|" -%}
        {%- for pair in _pairs -%}
          {%- assign kv = pair | split: ":" -%}
          {%- if kv[0] == _bysetpos -%}
            {%- assign _pos_pretty = kv[1] -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- assign _schedule_phrase = "" -%}
      {%- if n.schedule_text and n.schedule_text != "" -%}
        {%- assign _schedule_phrase = n.schedule_text -%}
      {%- else -%}
        {%- if _freq == "DAILY" -%}
          {%- assign _schedule_phrase = "Daily" -%}
        {%- elsif _freq == "MONTHLY" and _pos_pretty != "" and _byday_pretty != "" -%}
          {%- assign _schedule_phrase = _pos_pretty | append: " " | append: _byday_pretty | replace: "s", "" -%}
        {%- elsif _byday_pretty != "" -%}
          {%- assign _schedule_phrase = _byday_pretty -%}
        {%- endif -%}

        {%- if _schedule_phrase == "" and _display_time != "" -%}
          {%- assign _schedule_phrase = _display_time | append: " " | append: _tz_full -%}
        {%- elsif _schedule_phrase != "" and _display_time != "" -%}
          {%- assign _schedule_phrase = _schedule_phrase | append: " at " | append: _display_time | append: " " | append: _tz_full -%}
        {%- endif -%}
      {%- endif -%}

      <article class="net-block">
        <h3>{{ n.name }}</h3>
        <p class="net-when">
          <strong>When:</strong>
          {%- if _schedule_phrase != "" -%}{{ _schedule_phrase }}{%- else -%}—{%- endif -%}
          {%- if n.duration_min %} ({{ n.duration_min }} min){% endif -%}
        </p>
        {%- if n.id == "bh-digital" -%}<p><a href="#{{ nco_anchor }}">See NCO schedule ↓</a></p>{%- endif -%}
        <p class="net-where"><strong>Where:</strong> {% include net_location.html net=n %}</p>
        <p class="net-desc">{{ n.description }}</p>
      </article>
      {% unless forloop.last %}<hr>{% endunless %}
    {% endfor %}
  </div>
</section>

<script defer src="/assets/js/net-view.js"></script>
