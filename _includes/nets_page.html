{%- comment -%}
Renders a list of nets (table + headings views) with humanized schedule text.

Expected fields per net (you can provide only rrule + start_local):
  id, name, description,
  start_local ("HH:MM" 24h),
  duration_min,
  rrule (e.g., "FREQ=WEEKLY;BYDAY=SA" or "FREQ=MONTHLY;BYDAY=TH;BYSETPOS=1"),
  tz_full (optional, e.g., "Eastern"),
  schedule_text (optional override string shown verbatim),
  location fields used by net_location.html

We parse RRULE into FREQ/BYDAY/BYSETPOS when present.
{%- endcomment -%}

{%- assign title = include.title | default: "Nets" -%}
{%- assign cat = include.category | default: "bhn" -%}
{%- assign section_id = include.section_id | default: "nets-section" -%}
{%- assign nco_anchor = include.nco_anchor | default: "nco-schedule" -%}
{%- assign filtered = include.nets | where: "category", cat -%}

{%- comment -%}
Helper snippet: given n, compute:
  _tz_full, _display_time, _rfreq, _byday_codes, _bysetpos, _byday_names_singular, _byday_names_plural, _ord_word, _schedule_phrase
This block is duplicated in both views (scoped to each n).
{%- endcomment -%}

{%- if jekyll.environment == 'development' -%}
  {%- assign json_src = "/.netlify/functions/proxy-next-nets" -%}
{%- else -%}
  {%- assign json_src = "https://data.blindhams.network/next_nets.json" -%}
{%- endif -%}
<section class="nets-section" data-view="table" id="{{ section_id }}" data-next-net-json="{{ json_src }}"
  data-tz-show-abbr="{%- if site.time_labels.show_abbr == false or site.time_labels.show_abbr == 'false' -%}false{%- elsif site.time_labels.show_abbr == true or site.time_labels.show_abbr == 'true' -%}true{%- else -%}true{%- endif -%}"
  data-tz-show-label="{%- if site.time_labels.show_label == false or site.time_labels.show_label == 'false' -%}false{%- elsif site.time_labels.show_label == true or site.time_labels.show_label == 'true' -%}true{%- else -%}true{%- endif -%}"
  {%- if include.force_tz_iana and include.force_tz_iana != '' -%}
  data-tz-force-iana="{{ include.force_tz_iana }}"
  {%- endif -%}
>
  <header class="nets-header">
    <h2>{{ title }}</h2>

    <fieldset class="view-toggle" aria-label="Display format">
      <legend class="sr-only">Display format</legend>
      <button type="button" data-view-button="table" aria-pressed="true">Table view</button>
      <button type="button" data-view-button="headings" aria-pressed="false">Headings view</button>
      <span class="sr-only" role="status" aria-live="polite" aria-atomic="true" data-net-view-status></span>
    </fieldset>

    <fieldset class="view-toggle" aria-label="Time display">
      <legend class="sr-only">Time display</legend>
      <button type="button" data-time-button="net" aria-pressed="true">Net time <span class="time-tz-label" data-time-tz-label></span></button>
      <button type="button" data-time-button="my" aria-pressed="false">My time <span class="time-tz-label" data-time-my-tz-label></span></button>
      <label class="time-utc-toggle"><input type="checkbox" data-time-utc-toggle> Show UTC</label>
      <span class="sr-only" role="status" aria-live="polite" aria-atomic="true" data-time-view-status></span>
    </fieldset>
  </header>

  <!-- TABLE VIEW -->
  <div class="view view-table">
    <table>
      <thead>
        <tr>
          <th scope="col">Net</th>
          <th scope="col">Description</th>
          <th scope="col">When</th>
          <th scope="col">Duration</th>
          <th scope="col">AllStar</th>
          <th scope="col">EchoLink</th>
          <th scope="col">Other modes</th>
        </tr>
      </thead>
      <tbody>
      {% for n in filtered %}
        {%- assign tzname = n.time_zone | default: "America/New_York" -%}
        {%- assign _tz_full = tzname
          | replace: "America/New_York", "Eastern"
          | replace: "America/Los_Angeles", "Pacific"
          | replace: "America/Chicago", "Central"
          | replace: "America/Denver", "Mountain" -%}

        {%- comment -%} Time display from start_local or legacy " at " in rrule {%- endcomment -%}
        {%- assign _display_time = "" -%}
        {%- if n.start_local and n.start_local != "" -%}
          {%- assign _tparse = '2000-01-01 ' | append: n.start_local -%}
          {%- assign _display_time = _tparse | date: "%-I:%M %p" -%}
        {%- elsif n.rrule and n.rrule contains " at " -%}
          {%- assign _at_bits = n.rrule | split: " at " -%}
          {%- assign _legacy = '2000-01-01 ' | append: _at_bits.last -%}
          {%- assign _display_time = _legacy | date: "%-I:%M %p" -%}
        {%- endif -%}

        {%- comment -%} Parse RRULE into freq/day/setpos {%- endcomment -%}
        {%- assign _rfreq = "" -%}
        {%- assign _rbyday = "" -%}
        {%- assign _rbysetpos = "" -%}
        {%- if n.rrule and n.rrule != "" -%}
          {%- assign _parts = n.rrule | split: ";" -%}
          {%- for p in _parts -%}
            {%- assign kv = p | split: "=" -%}
            {%- assign k = kv[0] | upcase -%}
            {%- assign v = kv[1] -%}
            {%- if k == "FREQ" -%}{%- assign _rfreq = v | upcase -%}{%- endif -%}
            {%- if k == "BYDAY" -%}{%- assign _rbyday = v -%}{%- endif -%}
            {%- if k == "BYSETPOS" -%}{%- assign _rbysetpos = v -%}{%- endif -%}
          {%- endfor -%}
        {%- endif -%}

        {%- comment -%} Derive BYDAY codes (prefer explicit fields if provided) {%- endcomment -%}
        {%- assign _byday_codes = n.byday | default: _rbyday | default: "" -%}

        {%- comment -%} Humanize day names (full names) {%- endcomment -%}
        {%- assign _names = "" -%}
        {%- assign _day_list = "" | split: "" -%}
        {%- if _byday_codes != "" -%}
          {%- assign _days = _byday_codes | split: "," -%}
          {%- for d in _days -%}
            {%- assign d2 = d | strip | upcase -%}
            {%- assign day_full = d2
              | replace: "MO","Monday"
              | replace: "TU","Tuesday"
              | replace: "WE","Wednesday"
              | replace: "TH","Thursday"
              | replace: "FR","Friday"
              | replace: "SA","Saturday"
              | replace: "SU","Sunday" -%}
            {%- assign _day_list = _day_list | push: day_full -%}
          {%- endfor -%}
          {%- assign _names = "" -%}
          {%- for dn in _day_list -%}
            {%- if forloop.first -%}
              {%- assign _names = dn -%}
            {%- elsif forloop.last -%}
              {%- assign _names = _names | append: " & " | append: dn -%}
            {%- else -%}
              {%- assign _names = _names | append: ", " | append: dn -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}

        {%- comment -%} Build pluralized version for weekly phrasing (e.g., "Saturdays") {%- endcomment -%}
        {%- assign _names_plural = _names -%}
        {%- if _day_list and _day_list.size == 1 -%}
          {%- assign _names_plural = _day_list[0] | append: "s" -%}
        {%- endif -%}

        {%- comment -%} Ordinal word for BYSETPOS (MONTHLY) {%- endcomment -%}
        {%- assign _ord_word = "" -%}
        {%- if _rbysetpos and _rbysetpos != "" -%}
          {%- assign _ord_map = "1:First|2:Second|3:Third|4:Fourth|5:Fifth|-1:Last" | split: "|" -%}
          {%- for pair in _ord_map -%}
            {%- assign kv = pair | split: ":" -%}
            {%- if kv[0] == _rbysetpos -%}{%- assign _ord_word = kv[1] -%}{%- endif -%}
          {%- endfor -%}
        {%- endif -%}

        {%- comment -%} Compose the schedule phrase {%- endcomment -%}
        {%- assign _schedule_phrase = "" -%}
        {%- if n.schedule_text and n.schedule_text != "" -%}
          {%- assign _schedule_phrase = n.schedule_text -%}
        {%- else -%}
          {%- case _rfreq -%}
            {%- when "DAILY" -%}
              {%- assign _schedule_phrase = "Daily" -%}
            {%- when "WEEKLY" -%}
              {%- if _names_plural != "" -%}
                {%- assign _schedule_phrase = _names_plural -%}
              {%- else -%}
                {%- assign _schedule_phrase = "Weekly" -%}
              {%- endif -%}
            {%- when "MONTHLY" -%}
              {%- if _ord_word != "" and _names != "" -%}
                {%- assign _schedule_phrase = _ord_word | append: " " | append: _names | append: " of the month" -%}
              {%- else -%}
                {%- assign _schedule_phrase = "Monthly" -%}
              {%- endif -%}
            {%- else -%}
              {%- if _names_plural != "" -%}
                {%- assign _schedule_phrase = _names_plural -%}
              {%- endif -%}
          {%- endcase -%}

          {%- if _display_time != "" -%}
            {%- if _schedule_phrase == "" -%}
              {%- assign _schedule_phrase = _display_time | append: " " | append: _tz_full -%}
            {%- else -%}
              {%- assign _schedule_phrase = _schedule_phrase | append: " at " | append: _display_time | append: " " | append: _tz_full -%}
            {%- endif -%}
          {%- endif -%}
        {%- endif -%}

        <tr>
          <td>
            <strong>{{ n.name }}</strong>
            {%- if n.id == "bh-digital" -%}
              <br><a href="#{{ nco_anchor }}">See NCO schedule <span aria-hidden="true">↓</span></a>
            {%- endif -%}
          </td>
          <td class="net-desc">{{ n.description | markdownify | replace: "<p>", "" | replace: "</p>", "" | strip }}</td>
          <td>
            {%- if _schedule_phrase != "" -%}{{ _schedule_phrase }}{%- else -%}—{%- endif -%}
            <div class="net-next-when" data-net-id="{{ n.id }}"></div>
          </td>
          <td>{%- if n.duration_min -%}{{ n.duration_min }} min{%- else -%}—{%- endif -%}</td>
          <td>{%- if n.allstar and n.allstar != "" -%}{{ n.allstar }}{%- else -%}—{%- endif -%}</td>
          <td>{%- if n.echolink and n.echolink != "" -%}{{ n.echolink }}{%- else -%}—{%- endif -%}</td>
          <td>
            {%- assign _other = "" | split: "" -%}
            {%- if n.frequency -%}
              {%- assign _freq = n.frequency -%}
              {%- if n.mode and n.mode != "" -%}{%- assign _freq = _freq | append: " " | append: n.mode -%}{%- endif -%}
              {%- assign _other = _other | push: _freq -%}
            {%- endif -%}
            {%- assign _dmr_sys = n.dmr_system | default: n.DMR_System -%}
            {%- assign _dmr_tg = n.dmr_tg | default: n.DMR_TG -%}
            {%- assign _has_dmr_struct = '' -%}
            {%- if _dmr_sys and _dmr_tg -%}{%- assign _has_dmr_struct = 'yes' -%}{%- endif -%}
            {%- if n.talkgroup and _has_dmr_struct == '' -%}
              {%- assign _other = _other | push: "Talkgroup " | push: n.talkgroup -%}
            {%- endif -%}
            {%- assign _dmr_val = n.dmr | default: n.DMR -%}
            {%- if _dmr_sys and _dmr_tg -%}
              {%- assign _other = _other | push: "DMR " | push: _dmr_sys | push: " TG " | push: _dmr_tg -%}
            {%- elsif _dmr_val -%}
              {%- assign _other = _other | push: "DMR " | push: _dmr_val -%}
            {%- endif -%}
            {%- assign _dstar = n.dstar | default: n.DStar -%}
            {%- if _dstar -%}
              {%- assign _other = _other | push: "D-STAR " | push: _dstar -%}
            {%- endif -%}
            {%- if n.peanut -%}
              {%- assign _other = _other | push: "Peanut " | push: n.peanut -%}
            {%- endif -%}
            {%- if n.ysf -%}
              {%- assign _other = _other | push: "YSF " | push: n.ysf -%}
            {%- endif -%}
            {%- assign _wiresx = n.wiresx | default: n.wires_x -%}
            {%- if _wiresx -%}
              {%- assign _other = _other | push: "WIRES-X " | push: _wiresx -%}
            {%- endif -%}
            {%- if n.p25 -%}
              {%- assign _other = _other | push: "P25 " | push: n.p25 -%}
            {%- endif -%}
            {%- if n.nxdn -%}
              {%- assign _other = _other | push: "NXDN " | push: n.nxdn -%}
            {%- endif -%}
            {%- assign _other_joined = _other | join: ", " | strip -%}
            {%- if _other_joined == "" and n.location -%}
              {%- assign _loc = n.location | markdownify | replace: "<p>", "" | replace: "</p>", "" | strip -%}
              {%- assign _other_joined = _loc -%}
            {%- endif -%}
            {%- if _other_joined == "" and n.website -%}
              {%- assign _other_joined = "[More info](" | append: n.website | append: ")" 
                 | markdownify | replace: "<p>", "" | replace: "</p>", "" | strip -%}
            {%- endif -%}
            {%- if _other_joined != "" -%}{{ _other_joined }}{%- else -%}—{%- endif -%}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- HEADINGS VIEW -->
  <div class="view view-headings" hidden>
    {% for n in filtered %}
      {%- assign tzname = n.time_zone | default: "America/New_York" -%}
      {%- assign _tz_full = tzname
        | replace: "America/New_York", "Eastern"
        | replace: "America/Los_Angeles", "Pacific"
        | replace: "America/Chicago", "Central"
        | replace: "America/Denver", "Mountain" -%}

      {%- assign _display_time = "" -%}
      {%- if n.start_local and n.start_local != "" -%}
        {%- assign _tparse = '2000-01-01 ' | append: n.start_local -%}
        {%- assign _display_time = _tparse | date: "%-I:%M %p" -%}
      {%- elsif n.rrule and n.rrule contains " at " -%}
        {%- assign _at_bits = n.rrule | split: " at " -%}
        {%- assign _legacy = '2000-01-01 ' | append: _at_bits.last -%}
        {%- assign _display_time = _legacy | date: "%-I:%M %p" -%}
      {%- endif -%}

      {%- assign _rfreq = "" -%}
      {%- assign _rbyday = "" -%}
      {%- assign _rbysetpos = "" -%}
      {%- if n.rrule and n.rrule != "" -%}
        {%- assign _parts = n.rrule | split: ";" -%}
        {%- for p in _parts -%}
          {%- assign kv = p | split: "=" -%}
          {%- assign k = kv[0] | upcase -%}
          {%- assign v = kv[1] -%}
          {%- if k == "FREQ" -%}{%- assign _rfreq = v | upcase -%}{%- endif -%}
          {%- if k == "BYDAY" -%}{%- assign _rbyday = v -%}{%- endif -%}
          {%- if k == "BYSETPOS" -%}{%- assign _rbysetpos = v -%}{%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- assign _byday_codes = n.byday | default: _rbyday | default: "" -%}
      {%- assign _names = "" -%}
      {%- assign _day_list = "" | split: "" -%}
      {%- if _byday_codes != "" -%}
        {%- assign _days = _byday_codes | split: "," -%}
        {%- for d in _days -%}
          {%- assign d2 = d | strip | upcase -%}
          {%- assign day_full = d2
            | replace: "MO","Monday"
            | replace: "TU","Tuesday"
            | replace: "WE","Wednesday"
            | replace: "TH","Thursday"
            | replace: "FR","Friday"
            | replace: "SA","Saturday"
            | replace: "SU","Sunday" -%}
          {%- assign _day_list = _day_list | push: day_full -%}
        {%- endfor -%}
        {%- for dn in _day_list -%}
          {%- if forloop.first -%}
            {%- assign _names = dn -%}
          {%- elsif forloop.last -%}
            {%- assign _names = _names | append: " & " | append: dn -%}
          {%- else -%}
            {%- assign _names = _names | append: ", " | append: dn -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
      {%- assign _names_plural = _names -%}
      {%- if _day_list and _day_list.size == 1 -%}
        {%- assign _names_plural = _day_list[0] | append: "s" -%}
      {%- endif -%}

      {%- assign _ord_word = "" -%}
      {%- if _rbysetpos and _rbysetpos != "" -%}
        {%- assign _ord_map = "1:First|2:Second|3:Third|4:Fourth|5:Fifth|-1:Last" | split: "|" -%}
        {%- for pair in _ord_map -%}
          {%- assign kv = pair | split: ":" -%}
          {%- if kv[0] == _rbysetpos -%}{%- assign _ord_word = kv[1] -%}{%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- assign _schedule_phrase = "" -%}
      {%- if n.schedule_text and n.schedule_text != "" -%}
        {%- assign _schedule_phrase = n.schedule_text -%}
      {%- else -%}
        {%- case _rfreq -%}
          {%- when "DAILY" -%}
            {%- assign _schedule_phrase = "Daily" -%}
          {%- when "WEEKLY" -%}
            {%- if _names_plural != "" -%}
              {%- assign _schedule_phrase = _names_plural -%}
            {%- else -%}
              {%- assign _schedule_phrase = "Weekly" -%}
            {%- endif -%}
          {%- when "MONTHLY" -%}
            {%- if _ord_word != "" and _names != "" -%}
              {%- assign _schedule_phrase = _ord_word | append: " " | append: _names | append: " of the month" -%}
            {%- else -%}
              {%- assign _schedule_phrase = "Monthly" -%}
            {%- endif -%}
          {%- else -%}
            {%- if _names_plural != "" -%}
              {%- assign _schedule_phrase = _names_plural -%}
            {%- endif -%}
        {%- endcase -%}

        {%- if _display_time != "" -%}
          {%- if _schedule_phrase == "" -%}
            {%- assign _schedule_phrase = _display_time | append: " " | append: _tz_full -%}
          {%- else -%}
            {%- assign _schedule_phrase = _schedule_phrase | append: " at " | append: _display_time | append: " " | append: _tz_full -%}
          {%- endif -%}
        {%- endif -%}
      {%- endif -%}

      <article class="net-block">
        <h3>{{ n.name }}</h3>
        <p class="net-when">
          <strong>When:</strong>
          {%- if _schedule_phrase != "" -%}{{ _schedule_phrase }}{%- else -%}—{%- endif -%}
          {%- if n.duration_min %} ({{ n.duration_min }} min){% endif -%}
          <span class="net-next-when" data-net-id="{{ n.id }}"></span>
        </p>
        {%- if n.id == "bh-digital" -%}
          <p><a href="#{{ nco_anchor }}">See NCO schedule <span aria-hidden="true">↓</span></a></p>
        {%- endif -%}
        <p class="net-where"><strong>Where:</strong> {% include net_location.html net=n %}</p>

        {%- assign _other = "" | split: "" -%}
        {%- if n.frequency -%}
          {%- assign _freq = n.frequency -%}
          {%- if n.mode and n.mode != "" -%}{%- assign _freq = _freq | append: " " | append: n.mode -%}{%- endif -%}
          {%- assign _other = _other | push: _freq -%}
        {%- endif -%}
        {%- if n.talkgroup -%}
          {%- assign _other = _other | push: "Talkgroup " | push: n.talkgroup -%}
        {%- endif -%}
        {%- assign _dstar = n.dstar | default: n.DStar -%}
        {%- if _dstar -%}
          {%- assign _other = _other | push: "D-STAR " | push: _dstar -%}
        {%- endif -%}
        {%- if n.peanut -%}
          {%- assign _other = _other | push: "Peanut " | push: n.peanut -%}
        {%- endif -%}
        {%- if n.ysf -%}
          {%- assign _other = _other | push: "YSF " | push: n.ysf -%}
        {%- endif -%}
        {%- assign _wiresx = n.wiresx | default: n.wires_x -%}
        {%- if _wiresx -%}
          {%- assign _other = _other | push: "WIRES-X " | push: _wiresx -%}
        {%- endif -%}
        {%- if n.p25 -%}
          {%- assign _other = _other | push: "P25 " | push: n.p25 -%}
        {%- endif -%}
        {%- if n.nxdn -%}
          {%- assign _other = _other | push: "NXDN " | push: n.nxdn -%}
        {%- endif -%}
        {%- assign _other_joined = _other | join: " · " | strip -%}

        <p class="net-connections">
          <strong>Connections:</strong>
          AllStar: {%- if n.allstar and n.allstar != "" -%} {{ n.allstar }} {%- else -%} — {%- endif -%},
          EchoLink: {%- if n.echolink and n.echolink != "" -%} {{ n.echolink }} {%- else -%} — {%- endif -%}
          {%- if _other_joined != "" -%}
          , Other: {{ _other_joined }}
          {%- endif -%}
        </p>
        <div class="net-desc">{{ n.description | markdownify }}</div>
      </article>
      {% unless forloop.last %}<hr>{% endunless %}
    {% endfor %}
  </div>
</section>

<script defer src="/assets/js/time-view.js?v={{ site.github.build_revision | default: site.time | date: '%s' }}"></script>
<script defer src="/assets/js/json-widgets.js?v={{ site.github.build_revision | default: site.time | date: '%s' }}"></script>
<script defer src="/assets/js/net-view.js"></script>
