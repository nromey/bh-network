{%- assign payload = site.data.next_net -%}
{%- assign json_src = "https://data.blindhams.network/next_nets.json" -%}
{%- assign all_nets = site.data.nets.nets | default: empty -%}
{%- if payload -%}
<section class="home-next-nets" aria-labelledby="next-net-heading" data-next-net-json="{{ json_src }}">
  <h2 id="next-net-heading">Up Next on the Blind Hams Bridge</h2>
  {%- assign next = payload.next_net -%}
  {%- if next -%}
  <article class="next-net-card" aria-labelledby="next-net-title">
    <h3 id="next-net-title">{{ next.name }}</h3>
    <p class="next-net-meta">
      <span class="next-net-label">When</span>
      <time datetime="{{ next.start_local_iso }}">{{ next.start_local_iso | date: "%A, %B %-d, %Y at %-I:%M %p" }}</time>
      <span class="next-net-tz">{{ next.time_zone
        | replace: "America/New_York", "Eastern"
        | replace: "America/Los_Angeles", "Pacific"
        | replace: "America/Chicago", "Central"
        | replace: "America/Denver", "Mountain" }}</span>
      {%- if next.duration_min -%}
      <span class="next-net-duration">· {{ next.duration_min }} min</span>
      {%- endif -%}
    </p>
    {%- comment -%} Connections for the next-up card {%- endcomment -%}
    {%- assign next_net_def = all_nets | where: "id", next.id | first -%}
    {%- assign nc = next.connections | default: nil -%}
    {%- assign _allstar = nil -%}
    {%- assign _echolink = nil -%}
    {%- if nc -%}
      {%- assign _allstar = nc.allstar -%}
      {%- assign _echolink = nc.echolink -%}
    {%- endif -%}
    {%- if _allstar == nil and next_net_def and next_net_def.allstar -%}{%- assign _allstar = next_net_def.allstar -%}{%- endif -%}
    {%- if _echolink == nil and next_net_def and next_net_def.echolink -%}{%- assign _echolink = next_net_def.echolink -%}{%- endif -%}

    {%- assign _other = "" | split: "" -%}
    {%- assign _freq = nil -%}
    {%- if nc and nc.frequency -%}
      {%- assign _freq = nc.frequency -%}
      {%- if nc.mode and nc.mode != "" -%}{%- assign _freq = _freq | append: " " | append: nc.mode -%}{%- endif -%}
    {%- elsif next_net_def and next_net_def.frequency -%}
      {%- assign _freq = next_net_def.frequency -%}
      {%- if next_net_def.mode and next_net_def.mode != "" -%}{%- assign _freq = _freq | append: " " | append: next_net_def.mode -%}{%- endif -%}
    {%- endif -%}
    {%- if _freq -%}{%- assign _other = _other | push: _freq -%}{%- endif -%}
    {%- assign _dmr_sys = nc.dmr_system | default: next_net_def.dmr_system | default: next_net_def.DMR_System -%}
    {%- assign _dmr_tg = nc.dmr_tg | default: next_net_def.dmr_tg | default: next_net_def.DMR_TG -%}
    {%- assign _has_dmr_struct = '' -%}
    {%- if _dmr_sys and _dmr_tg -%}{%- assign _has_dmr_struct = 'yes' -%}{%- endif -%}
    {%- assign _tg = nc.talkgroup | default: next_net_def.talkgroup -%}
    {%- if _tg and _has_dmr_struct == '' -%}{%- assign _other = _other | push: "Talkgroup " | push: _tg -%}{%- endif -%}
    {%- assign _dmr = nc.dmr | default: next_net_def.dmr | default: next_net_def.DMR -%}
    {%- if _dmr_sys and _dmr_tg -%}
      {%- assign _other = _other | push: "DMR " | push: _dmr_sys | push: " TG " | push: _dmr_tg -%}
    {%- elsif _dmr -%}
      {%- assign _other = _other | push: "DMR " | push: _dmr -%}
    {%- endif -%}
    {%- assign _dstar = nc.dstar | default: next_net_def.dstar | default: next_net_def.DStar -%}
    {%- if _dstar -%}{%- assign _other = _other | push: "D-STAR " | push: _dstar -%}{%- endif -%}
    {%- assign _peanut = nc.peanut | default: next_net_def.peanut -%}
    {%- if _peanut -%}{%- assign _other = _other | push: "Peanut " | push: _peanut -%}{%- endif -%}
    {%- assign _ysf = nc.ysf | default: next_net_def.ysf -%}
    {%- if _ysf -%}{%- assign _other = _other | push: "YSF " | push: _ysf -%}{%- endif -%}
    {%- assign _wiresx = nc.wiresx | default: nc.wires_x | default: next_net_def.wiresx | default: next_net_def.wires_x -%}
    {%- if _wiresx -%}{%- assign _other = _other | push: "WIRES-X " | push: _wiresx -%}{%- endif -%}
    {%- assign _p25 = nc.p25 | default: next_net_def.p25 -%}
    {%- if _p25 -%}{%- assign _other = _other | push: "P25 " | push: _p25 -%}{%- endif -%}
    {%- assign _nxdn = nc.nxdn | default: next_net_def.nxdn -%}
    {%- if _nxdn -%}{%- assign _other = _other | push: "NXDN " | push: _nxdn -%}{%- endif -%}
    {%- assign _mode_up = nc.mode | default: next_net_def.mode | upcase -%}
    {%- if _dmr == nil and _mode_up == "DMR" -%}
      {%- assign _other = _other | push: "DMR" -%}
    {%- endif -%}
    {%- assign _other_joined = _other | join: ", " | strip -%}

    <p class="next-net-connections">
      <span class="next-net-label">Connections</span>
      AllStar: {%- if _allstar and _allstar != "" -%} {{ _allstar }} {%- else -%} — {%- endif -%},
      EchoLink: {%- if _echolink and _echolink != "" -%} {{ _echolink }} {%- else -%} — {%- endif -%}
      {%- if _other_joined != "" -%}
      , Other: {{ _other_joined }}
      {%- endif -%}
    </p>
    <h4>What to expect</h4>
    <div class="next-net-description">{{ next.description | markdownify }}</div>
  </article>
  {%- else -%}
  <p class="next-net-empty">No upcoming nets found in this category.</p>
  {%- endif -%}

  {%- assign week = payload.week -%}
  {%- if week and week != empty -%}
  {%- assign week_sorted = week | sort: "start_local_iso" -%}
  {%- assign available_categories = payload.categories | default: empty -%}
  {%- assign default_categories = payload.default_categories | default: nil -%}
  {%- if default_categories == nil or default_categories == empty -%}
    {%- assign default_categories = payload.primary_category | split: "," -%}
  {%- endif -%}
  <details class="next-net-accordion">
    <summary id="week-nets-summary"><span>Show nets for the next week</span></summary>
    <div class="next-net-accordion-body" aria-labelledby="week-nets-summary">
      <section class="nets-section home-week-nets" data-view="table" id="home-week-nets" data-primary-category="{{ payload.primary_category }}">
        <header class="nets-header">
          <h3>Week at a glance</h3>
          {%- if available_categories and available_categories != empty -%}
          <fieldset class="week-category-filter" aria-label="Filter weekly nets by category">
            <legend>Categories</legend>
            <div class="week-category-options">
            {%- for cat in available_categories -%}
              {%- capture cat_label -%}
                {%- case cat -%}
                  {%- when "bhn" -%}Blind Hams Network
                  {%- when "disability" -%}Disability Nets
                  {%- when "general" -%}General Interest
                  {%- else -%}{{ cat | capitalize }}
                {%- endcase -%}
              {%- endcapture -%}
              <div class="week-category-option">
                <input type="checkbox" id="week-cat-{{ cat }}" value="{{ cat }}" data-category-toggle data-label="{{ cat_label | strip }}" {% if default_categories contains cat %}checked{% endif %}>
                <label for="week-cat-{{ cat }}">{{ cat_label | strip }}</label>
              </div>
            {%- endfor -%}
            </div>
            <div class="week-category-actions">
              {%- capture primary_label -%}
                {%- case payload.primary_category -%}
                  {%- when "bhn" -%}Blind Hams only
                  {%- when "disability" -%}Disability only
                  {%- when "general" -%}General Interest only
                  {%- else -%}Primary category only
                {%- endcase -%}
              {%- endcapture -%}
              <button type="button" data-category-select="all">Select all</button>
              <button type="button" data-category-select="primary">{{ primary_label | strip }}</button>
            </div>
            <span class="sr-only" role="status" aria-live="polite" aria-atomic="true" data-week-filter-status></span>
          </fieldset>
          {%- endif -%}
          <fieldset class="view-toggle" aria-label="Display format for weekly nets">
            <legend class="sr-only">Display format</legend>
            <button type="button" data-view-button="table" aria-pressed="true">Table view</button>
            <button type="button" data-view-button="headings" aria-pressed="false">Headings view</button>
            <span class="sr-only" role="status" aria-live="polite" aria-atomic="true" data-net-view-status></span>
          </fieldset>
        </header>

        <p class="week-empty-message" hidden data-week-empty>No categories selected. Choose at least one category to show weekly nets.</p>

        <div class="view view-table">
          <table>
            <thead>
              <tr>
                <th scope="col">Net</th>
                <th scope="col">Description</th>
                <th scope="col">When</th>
                <th scope="col">Duration</th>
                <th scope="col">AllStar</th>
                <th scope="col">EchoLink</th>
                <th scope="col">Other modes</th>
              </tr>
            </thead>
            <tbody>
              {%- for occ in week_sorted -%}
                {%- assign net = all_nets | where: "id", occ.id | first -%}
                {%- assign is_default = default_categories contains occ.category -%}
                <tr data-category-item data-category="{{ occ.category }}" {% unless is_default %}hidden{% endunless %}>
                  <td>
                    <strong>{{ occ.name }}</strong>
                  </td>
                  <td class="net-desc">{{ occ.description | markdownify | replace: "<p>", "" | replace: "</p>", "" | strip }}</td>
                  <td>
                    <time datetime="{{ occ.start_local_iso }}">{{ occ.start_local_iso | date: "%A, %B %-d at %-I:%M %p" }}</time>
                    <span class="next-net-tz">{{ occ.time_zone
                      | replace: "America/New_York", "Eastern"
                      | replace: "America/Los_Angeles", "Pacific"
                      | replace: "America/Chicago", "Central"
                      | replace: "America/Denver", "Mountain" }}</span>
                  </td>
                  <td>{%- if occ.duration_min -%}{{ occ.duration_min }} min{%- else -%}—{%- endif -%}</td>
                  {%- assign oc = occ.connections | default: nil -%}
                  <td>{%- if oc and oc.allstar -%}{{ oc.allstar }}{%- elsif net and net.allstar -%}{{ net.allstar }}{%- else -%}—{%- endif -%}</td>
                  <td>{%- if oc and oc.echolink -%}{{ oc.echolink }}{%- elsif net and net.echolink -%}{{ net.echolink }}{%- else -%}—{%- endif -%}</td>
                  <td>
                    {%- assign _other = "" | split: "" -%}
                    {%- assign _freq = nil -%}
                    {%- if oc and oc.frequency -%}
                      {%- assign _freq = oc.frequency -%}
                      {%- if oc.mode and oc.mode != "" -%}{%- assign _freq = _freq | append: " " | append: oc.mode -%}{%- endif -%}
                    {%- elsif net and net.frequency -%}
                      {%- assign _freq = net.frequency -%}
                      {%- if net.mode and net.mode != "" -%}{%- assign _freq = _freq | append: " " | append: net.mode -%}{%- endif -%}
                    {%- endif -%}
                    {%- if _freq -%}{%- assign _other = _other | push: _freq -%}{%- endif -%}
                    {%- assign _dmr_sys = oc.dmr_system | default: net.dmr_system | default: net.DMR_System -%}
                    {%- assign _dmr_tg = oc.dmr_tg | default: net.dmr_tg | default: net.DMR_TG -%}
                    {%- assign _has_dmr_struct = '' -%}
                    {%- if _dmr_sys and _dmr_tg -%}{%- assign _has_dmr_struct = 'yes' -%}{%- endif -%}
                    {%- assign _tg = oc.talkgroup | default: net.talkgroup -%}
                    {%- if _tg and _has_dmr_struct == '' -%}{%- assign _other = _other | push: "Talkgroup " | push: _tg -%}{%- endif -%}
                    {%- assign _dstar = oc.dstar | default: net.dstar | default: net.DStar -%}
                    {%- if _dstar -%}{%- assign _other = _other | push: "D-STAR " | push: _dstar -%}{%- endif -%}
                    {%- assign _peanut = oc.peanut | default: net.peanut -%}
                    {%- if _peanut -%}{%- assign _other = _other | push: "Peanut " | push: _peanut -%}{%- endif -%}
                    {%- assign _ysf = oc.ysf | default: net.ysf -%}
                    {%- if _ysf -%}{%- assign _other = _other | push: "YSF " | push: _ysf -%}{%- endif -%}
                    {%- assign _wiresx = oc.wiresx | default: oc.wires_x | default: net.wiresx | default: net.wires_x -%}
                    {%- if _wiresx -%}{%- assign _other = _other | push: "WIRES-X " | push: _wiresx -%}{%- endif -%}
                    {%- assign _p25 = oc.p25 | default: net.p25 -%}
                    {%- if _p25 -%}{%- assign _other = _other | push: "P25 " | push: _p25 -%}{%- endif -%}
                    {%- assign _nxdn = oc.nxdn | default: net.nxdn -%}
                    {%- if _nxdn -%}{%- assign _other = _other | push: "NXDN " | push: _nxdn -%}{%- endif -%}
                    {%- assign _dmr = oc.dmr | default: net.dmr | default: net.DMR -%}
                    {%- if _has_dmr_struct == 'yes' -%}
                      {%- assign _other = _other | push: "DMR " | push: _dmr_sys | push: " TG " | push: _dmr_tg -%}
                    {%- elsif _dmr -%}
                      {%- assign _other = _other | push: "DMR " | push: _dmr -%}
                    {%- endif -%}
                    {%- assign _mode_up = oc.mode | default: net.mode | upcase -%}
                    {%- if _has_dmr_struct == '' and _dmr == nil and _mode_up == "DMR" -%}
                      {%- assign _other = _other | push: "DMR" -%}
                    {%- endif -%}
                    {%- assign _other_joined = _other | join: ", " | strip -%}
                    {%- if _other_joined == "" and net and net.location -%}
                      {%- assign _loc = net.location | markdownify | replace: "<p>", "" | replace: "</p>", "" | strip -%}
                      {%- assign _other_joined = _loc -%}
                    {%- endif -%}
                    {%- if _other_joined == "" and net and net.website -%}
                      {%- assign _other_joined = "[More info](" | append: net.website | append: ")" 
                         | markdownify | replace: "<p>", "" | replace: "</p>", "" | strip -%}
                    {%- endif -%}
                    {%- if _other_joined != "" -%}{{ _other_joined }}{%- else -%}—{%- endif -%}
                  </td>
                </tr>
              {%- endfor -%}
            </tbody>
          </table>
        </div>

        <div class="view view-headings" hidden>
          {%- for occ in week_sorted -%}
            {%- assign net = all_nets | where: "id", occ.id | first -%}
            {%- assign is_default = default_categories contains occ.category -%}
            <article class="next-net-item" aria-labelledby="week-net-{{ forloop.index }}" data-category-item data-category="{{ occ.category }}" {% unless is_default %}hidden{% endunless %}>
              <h4 id="week-net-{{ forloop.index }}">{{ occ.name }}</h4>
              <p class="next-net-meta">
                <span class="next-net-label">When</span>
                <time datetime="{{ occ.start_local_iso }}">{{ occ.start_local_iso | date: "%A, %B %-d at %-I:%M %p" }}</time>
                <span class="next-net-tz">{{ occ.time_zone
                  | replace: "America/New_York", "Eastern"
                  | replace: "America/Los_Angeles", "Pacific"
                  | replace: "America/Chicago", "Central"
                  | replace: "America/Denver", "Mountain" }}</span>
                {%- if occ.duration_min -%}
                <span class="next-net-duration">· {{ occ.duration_min }} min</span>
                {%- endif -%}
              </p>
              {%- assign oc = occ.connections | default: nil -%}
              {%- assign _allstar = nil -%}
              {%- assign _echolink = nil -%}
              {%- if oc -%}
                {%- assign _allstar = oc.allstar -%}
                {%- assign _echolink = oc.echolink -%}
              {%- endif -%}
              {%- if _allstar == nil and net and net.allstar -%}{%- assign _allstar = net.allstar -%}{%- endif -%}
              {%- if _echolink == nil and net and net.echolink -%}{%- assign _echolink = net.echolink -%}{%- endif -%}

              {%- assign _other = "" | split: "" -%}
              {%- assign _freq = nil -%}
              {%- if oc and oc.frequency -%}
                {%- assign _freq = oc.frequency -%}
                {%- if oc.mode and oc.mode != "" -%}{%- assign _freq = _freq | append: " " | append: oc.mode -%}{%- endif -%}
              {%- elsif net and net.frequency -%}
                {%- assign _freq = net.frequency -%}
                {%- if net.mode and net.mode != "" -%}{%- assign _freq = _freq | append: " " | append: net.mode -%}{%- endif -%}
              {%- endif -%}
              {%- if _freq -%}{%- assign _other = _other | push: _freq -%}{%- endif -%}
              {%- assign _dmr_sys = oc.dmr_system | default: net.dmr_system | default: net.DMR_System -%}
              {%- assign _dmr_tg = oc.dmr_tg | default: net.dmr_tg | default: net.DMR_TG -%}
              {%- assign _has_dmr_struct = '' -%}
              {%- if _dmr_sys and _dmr_tg -%}{%- assign _has_dmr_struct = 'yes' -%}{%- endif -%}
              {%- assign _tg = oc.talkgroup | default: net.talkgroup -%}
              {%- if _tg and _has_dmr_struct == '' -%}{%- assign _other = _other | push: "Talkgroup " | push: _tg -%}{%- endif -%}
              {%- assign _dstar = oc.dstar | default: net.dstar | default: net.DStar -%}
              {%- if _dstar -%}{%- assign _other = _other | push: "D-STAR " | push: _dstar -%}{%- endif -%}
              {%- assign _peanut = oc.peanut | default: net.peanut -%}
              {%- if _peanut -%}{%- assign _other = _other | push: "Peanut " | push: _peanut -%}{%- endif -%}
              {%- assign _ysf = oc.ysf | default: net.ysf -%}
              {%- if _ysf -%}{%- assign _other = _other | push: "YSF " | push: _ysf -%}{%- endif -%}
              {%- assign _wiresx = oc.wiresx | default: oc.wires_x | default: net.wiresx | default: net.wires_x -%}
              {%- if _wiresx -%}{%- assign _other = _other | push: "WIRES-X " | push: _wiresx -%}{%- endif -%}
              {%- assign _p25 = oc.p25 | default: net.p25 -%}
              {%- if _p25 -%}{%- assign _other = _other | push: "P25 " | push: _p25 -%}{%- endif -%}
              {%- assign _nxdn = oc.nxdn | default: net.nxdn -%}
              {%- if _nxdn -%}{%- assign _other = _other | push: "NXDN " | push: _nxdn -%}{%- endif -%}
              {%- assign _dmr = oc.dmr | default: net.dmr | default: net.DMR -%}
              {%- if _has_dmr_struct == 'yes' -%}
                {%- assign _other = _other | push: "DMR " | push: _dmr_sys | push: " TG " | push: _dmr_tg -%}
              {%- elsif _dmr -%}
                {%- assign _other = _other | push: "DMR " | push: _dmr -%}
              {%- endif -%}
              {%- assign _mode_up = oc.mode | default: net.mode | upcase -%}
              {%- if _has_dmr_struct == '' and _dmr == nil and _mode_up == "DMR" -%}
                {%- assign _other = _other | push: "DMR" -%}
              {%- endif -%}
              {%- assign _other_joined = _other | join: " · " | strip -%}

              <p class="next-net-connections">
                <span class="next-net-label">Connections</span>
                AllStar: {%- if _allstar and _allstar != "" -%} {{ _allstar }} {%- else -%} — {%- endif -%},
                EchoLink: {%- if _echolink and _echolink != "" -%} {{ _echolink }} {%- else -%} — {%- endif -%}
                {%- if _other_joined != "" -%}
                , Other: {{ _other_joined }}
                {%- endif -%}
              </p>
              <h5>About this net</h5>
              <div class="week-net-description">{{ occ.description | markdownify }}</div>
              <h5>Where</h5>
              <p>
                {%- if net -%}
                  {%- include net_location.html net=net -%}
                {%- else -%}
                  Blind Hams Bridge
                {%- endif -%}
              </p>
            </article>
          {%- endfor -%}
        </div>
      </section>
    </div>
  </details>
  {%- endif -%}
</section>
{%- endif -%}
<script defer src="{{ '/assets/js/json-widgets.js' | relative_url }}?v={{ site.github.build_revision | default: site.time | date: '%s' }}"></script>
<script defer src="{{ '/assets/js/home-week-filter.js' | relative_url }}?v={{ site.github.build_revision | default: site.time | date: '%s' }}"></script>
